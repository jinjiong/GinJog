<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>喵果</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" type="text/css" href="../css/iscroll-refresh.css">
	<link rel="stylesheet" type="text/css" href="../css/iconfont.css">
	<link rel="stylesheet" type="text/css" href="../css/style.css">
	<!-- 适配手机屏幕的大小 -->
	<script type="text/javascript" src='../js/flexible.js'></script>
</head>
<body class="nhome bgf2f0f0" onload="loaded()">
    <div class="indent-wrap">
        <div id="ir-tabs-wrapper">
            <div class="ir-tabs-scroller">
            </div>
        </div>
        <div style="clear:both"></div>
        <div id="ir-bd-wrapper">
            <div class="ir-bd-scroller">
                <div class="ir-wrapper" ><div class="ir-scroller" ></div></div>
                <div class="ir-wrapper" ><div class="ir-scroller" ></div></div>
                <div class="ir-wrapper" ><div class="ir-scroller" ></div></div>
                <div class="ir-wrapper" ><div class="ir-scroller" ></div></div>
                <div class="ir-wrapper" ><div class="ir-scroller" ></div></div>
                <div class="ir-wrapper" ><div class="ir-scroller" ></div></div>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript" src='../js/iscroll.js'></script>
<script type="text/javascript" src='../js/iscroll-probe.js'></script>
<script type="text/javascript" src='../js/iscroll-refresh.js'></script>
<script type="text/javascript" src="../js/jquery-1.12.2.min.js"></script>
<script type="text/javascript">

    var categorys = [17,18,19,2,14,15]; //每个类别的ID号
    var ir;
    var _index = localStorage.getItem('_index');
    function loaded () {
        $('.ir-scroller').each(function(index, el) {
            $(this).append('<div class="loader"><div class="line-scale"><div></div><div></div><div></div><div></div><div></div></div><div style="margin-top:15px">加载中...</div></div>');
        });
        ir = IR(['全部','待付款','待发货','待收货','待评价','已完成'],6)
        ir.downAction = pullDown; //下拉刷新取数据函数
        ir.upAction = pullUp; //上拉加载取数据函数
        ir.slideAction = slide; //左右滑动的回调函数
        $('.ir-bd-scroller').css('transform', 'translate(-'+$(window).width()* _index+'px, 0px)');
        $('.ir-tabs-scroller a').removeClass('active').eq(_index).addClass('active');
        $('.ir-tabs-scroller a.active').on('tap',function(){
            ir.bdScroll.goToPage(parseInt(_index),0,500);
        });
        $('.ir-tabs-scroller a.active').trigger('tap');
    }
    function pullDown(param){
        /*
        param.scroll  当前滚动的ISCROLL对象
        param.index   当前页面的索引，从0开始
        param.lastUpdate 上一次刷新的时间
        */
        var index = param.index;
        function callback(data){

            if(parseInt(data.code) == 200){
                
                for(var i=0;i<data.data.length;i++){
                    var art = data.data[i];
                    var html = parseHtml(art);
                    $('.ir-scroller').eq(index).prepend(html);
                }
                ir.pullDownCallBack(param); //这个一定要写，是隐藏上拉刷新提示用得
            }else{
                ir.pullDownCallBack(param,1); //后面的1代表没有更新的数据了，不传的话，还可以继续下拉
            }

        }
        testData(callback);
    };

    function pullUp(param){
        /*
        param.scroll  当前滚动的ISCROLL对象
        param.index   当前页面的索引，从0开始
        param.lastUpdate 上一次刷新的时间
        param.page  当前已经加载的页数
        */
        var index = param.index;
        var page = param.page;

        function callback(data){
            if(parseInt(data.code) == 200){
                for(var i=0;i<data.data.length;i++){
                    var art = data.data[i];
                    var html = parseHtml(art);
                    $('.ir-scroller').eq(index).append(html);
                }
                ir.pullUpCallBack(param); //还有数据的时候用这个
            }else{
                ir.pullUpCallBack(param,1); //没有更多数据的时候后面多加个1就行
            }
        }
        testData(callback);
    }
    function slide(index){
        console.log(index);
        if($('.ir-scroller').eq(index).find('div.loader').length >0){
            console.log('aa');
            initData(index,1);
        }
    }

    function initData(index,page){
        function callback(data){
            if(parseInt(data.code) == 200){
                 /* 测试*/
               if(false){
                var html = '<div class="no-order-info">'+
                                '<span class="no-icon"></span>'+
                                '<div class="info">您好久没在喵果下过单了~</div>'+
                                '<a class="button" href="/">去逛逛</a>'+
                            '</div>';
                 $('.ir-scroller').eq(index).append(html);
               }
               else{
                    for(var i=0;i<data.data.length;i++){
                        var art = data.data[i];
                        var html = parseHtml(art);
                        $('.ir-scroller').eq(index).append(html);
                    }
               }
               
                
            }

            $('.ir-scroller').eq(index).find('.loader').remove();

            ir.setPage(index,1);  //设置当前页面的页数
            ir.refresh(index); //刷新Iscroll
        }

        testData(callback);

    }
    function parseHtml(art){
        html= '<div class="indent-type-box">'+
            '<div class="indent-type-top">'+
                '<span class="title"><i class="iconfont icon-shangpin-copy"></i>果喵超市-新鲜水果</span>'+
                '<span class="state">交易成功</span>'+
            '</div>'+
            '<div class="indent-item clearfix">'+
            '<div class="clearfix">'+
               '<div class="img-box"><img src="../upload/po16.jpg"></div>'+
                    '<div class="text-box">'+
                        '<p class="indent-title">庄园精选喵果拼盘 <span class="time">2017-3-23</span></p>'+
                        '<p class="nub">规格：4件</p>'+
                        '<p class="serial">订单号：254985668</p>'+
                    '</div>'+
                '</div>'+
                '<p class="info-box">共4件商品 合计：￥36.9（含运费￥0.00）</p>'+
               '<div class="indent-item-bottom">'+
                    '<a href="订单详情.html">订单详情</a>'+
                    '<a href="">删除订单</a>'+
                   ' <a href="" class="active">去评价</a>'+
                '</div>'+
            '</div>'+
        '</div>';

        
        return html;
    }

    /*模拟AJAX获取数据*/
    function testData(callback){
        var article = {
                id:1,
                thumbnail:'http://7xn32g.com1.z0.glb.clouddn.com/_cloud_file_201653_121412_3571904.JPG?imageView2/1/w/140/h/110',
                title:'携程商旅联手明道抢滩企业级服务市场',
                created_at:'2016-06-01 12:22'
            };
        var data = new Array();
        for (var i = 0; i < 3; i++) {
            data.push(article);
        };

        setTimeout(function(){
            callback({code:200,data:data})
        },1000);
    }
</script>
</html>