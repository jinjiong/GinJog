<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">

<title>小尾巴</title>
<link  rel='stylesheet' type='text/css' href='css/iscroll-refresh.css'>
<link rel="stylesheet" type="text/css" href="css/mui.min.css">
<link rel="stylesheet" type="text/css" href="css/style.css">
<!--源码-->
<script type="text/javascript" src='js/iscroll.js'></script>
<script type="text/javascript" src="js/iscroll-probe.js"></script>
<script type="text/javascript" src="js/iscroll-refresh.js"></script>
<script type="text/javascript" src="js/jquery-1.12.2.min.js"></script>
<script type="text/javascript" src='js/json.js'></script>
<script type="text/javascript" src='js/flexible.js'></script>
<style type="text/css">
	.ir-scroller ul {
		list-style: none;
		padding: 0;
		margin: 0;
		width: 100%;
		text-align: left;
	}
	.ir-scroller li {
		padding: 10px;
		height: 100px;
		border-bottom: 1px solid #ccc;
		border-top: 1px solid #fff;
		background-color: #fafafa;
		font-size: 14px;
		list-style: none;
	}
	.ir-scroller li img{width: 35%; padding-right: 15px; float: left; height: 80px;}
	.ir-scroller li div.li-body{width: 65%;float: left; }
	.ir-scroller li div h3{padding-top: 0px; padding-bottom: 5px; font-weight: normal; line-height: 25px; margin: 0px}
	.ir-scroller li div p{margin: 0px; padding: 0px}
	.ir-scroller li a{ color: #333}

	
</style>

</head>
<body onload="loaded()">

	<div id="ir-tabs-wrapper">
		<div class="ir-tabs-scroller">
			<a class="active" href="#">全部<em></em></a>
			<a href="#">待付款<em></em></a>
			<a href="#">待服务<em></em></a>
			<a href="#">待确认<em></em></a>
			<a href="#">待评价<em></em></a>
		</div>
	</div>
	<div style="clear:both"></div>
	<div id="ir-bd-wrapper">
		<div class="ir-bd-scroller">
			<div class="ir-wrapper" ><div class="ir-scroller" ></div></div>
			<div class="ir-wrapper" ><div class="ir-scroller" ></div></div>
			<div class="ir-wrapper" ><div class="ir-scroller" ></div></div>
			<div class="ir-wrapper" ><div class="ir-scroller" ></div></div>
			<div class="ir-wrapper" ><div class="ir-scroller" ></div></div>
		</div>
	</div>
	<div class="pay-pop-bg">
		<div class="pay-pop">
			<div class="close"></div>
			<p class="title">付款详情</p>
			<p>会员账号<span>136****8888</span></p>
			<p>付款方式<span class="pay-other">会员卡余额支付</span></p>
			<p>需付款<span class="all-money">¥ 150.00</span></p>
             <div class="btn-box">
             	<span class="public-btn">立即付款</span>
             </div>
             <div class="pay-way">
	            <div class="close"></div>
				<p class="title">选择付款方式</p>
            	<p class="member-pay pay"><i class="member"></i>会员卡余额付款 </p>
            	<p class="weixin-pay pay"><i class="weixin"></i>微信支付</p>
            </div>
		</div>
	</div>
</body>
</html>

<script type="text/javascript">
	var categorys = [17,18,19,2,14]; //每个类别的ID来做链接地址
	var ir;
	var stats = {10:'付款',20:'已付款',30:'待服务',40:'待确定',80:'评价'};

function loaded () {
	$('.ir-scroller').each(function(index, el) {
		$(this).append('<div class="loader"><div class="line-scale"><div></div><div></div><div></div><div></div><div></div></div><div style="margin-top:15px">加载中...</div></div>');
	});
	ir = new iScrollRefresh('#ir-tabs-wrapper','#ir-bd-wrapper');
	
	ir.downAction = pullDown; //下拉刷新取数据函数
	ir.upAction = pullUp; //上拉加载取数据函数
	ir.slideAction = slide; //左右滑动的回调函数

	slide(0);//页面首次加载
}

function pullDown(param){
	/*
	param.scroll  当前滚动的ISCROLL对象
	param.index   当前页面的索引，从0开始
	param.lastUpdate 上一次刷新的时间
	*/
	var index = param.index;
	function callback(data){
		if(parseInt(data.code) == 200){
			for(var i=0;i<data.data.length;i++){
				var item = data.data[i];
				/*状态码转状态字*/
				item.status = stats[item.paymentStatus];
				var html = parseHtml(item);
				$('.ir-scroller').eq(index).prepend(html);
			}
			ir.pullDownCallBack(param); //这个一定要写，是隐藏上拉刷新提示用得
		}else{
			ir.pullDownCallBack(param,1); //后面的1代表没有更新的数据了，不传的话，还可以继续下拉
		}

	}
	testData(callback);
};

function pullUp(param){
	/*
	param.scroll  当前滚动的ISCROLL对象
	param.index   当前页面的索引，从0开始
	param.lastUpdate 上一次刷新的时间
	param.page  当前已经加载的页数
	*/
	var index = param.index;
	var page = param.page;
	console.log(page);
	function callback(data){
		
		if(parseInt(data.code) == 200){
			
			for(var i=0;i<data.data.length;i++){
				var item = data.data[i];
				/*状态码转状态字*/
				item.status = stats[item.paymentStatus];
				var html = parseHtml(item);
				$('.ir-scroller').eq(index).append(html);
			}
			ir.pullUpCallBack(param); //还有数据的时候用这个
		}else{
			ir.pullUpCallBack(param,1); //没有更多数据的时候后面多加个1就行
		}

	}
	testData(callback);
}

function slide(index){
	if($('.ir-scroller').eq(index).find('div.loader').length >0){
		initData(index,1);
	}
}

function initData(index,page){
	function callback(data){
		if(parseInt(data.code) == 200){
			for(var i=0;i<data.data.length;i++){
				var item = data.data[i];
				/*状态码转状态字*/
				item.status = stats[item.paymentStatus];
				var html = parseHtml(item);
				$('.ir-scroller').eq(index).append(html);
			}
			
		}

		$('.ir-scroller').eq(index).find('.loader').remove();

		ir.setPage(index,1);  //设置当前页面的页数
		ir.refresh(index); //刷新Iscroll
	}

	testData(callback);

	
}

function parseHtml(item){
	var special_hitl='';
	if (item.paymentStatus ==30) {
			special_hitl='<div class="special-box">';
		}
	 var StrHtml ='<div class="public-item" data-orderId="'+item.orderId+'">'+
			'<div class="info-box">'+
				'<span class="state">'+item.paymentStatusName+'</span>'+
				'<span class="title">'+item.storeName+'</span>'+
				'<p class="time">'+item.createdTime+'</p>'+
				'<p>服务项目：<span class="fc333">'+item.serviceTypeName+'</span></p>'+
				'<p>预支付金额：</p>'+
				'<span class="all-money">¥ '+item.prepayments+'</span>'+
				'<p class="hint">(与支付金额多余实际服务金额，多出部分将在服务完成后退还至相应的卡上)</p>'+
			'</div>'+
			'<div class="other-info">'+
				'<p><span class="title">门店地址：</span><span>'+item.storeAddress+'</span></p>'+
               '<p><span class="title">营业时间：</span>'+item.operateTimeDesc+'</p>'+
			'</div>'+
			'<div class="btn-box">'+
				'<span class="btn"  data-paymentstatus="'+item.paymentStatus+'">'+item.status+'</span>'+
			'</div>'+special_hitl+
			'</div>'+
		'</div>';
		
	return StrHtml;
	}

	/*模拟AJAX获取数据*/
	function testData(callback){

		/*模拟请求后端获得orders订单数组在json.js*/
		setTimeout(function(){
			callback({code:200,data:orders})
		},1000);
	}


	$('.ir-scroller').on('tap','.public-item',function(){
		window.location.href='indent_details.html?orderid='+$(this).data('orderid');
	})

     /*点击付款*/
     $('.ir-scroller').on('tap','.btn',function(){
     	if ($(this).data('paymentstatus')==10) {
            $('.pay-pop-bg').show();
     	}else if($(this).data('paymentstatus') ==80){
     		window.location.href='evaluate.html?orderid='+$(this).parents('.public-item').data('orderid');
     	}
     	return false;
     })

     $('.pay-pop .close').click(function(){
     	 $('.pay-pop-bg').hide();
     })

     /* 支付方式*/
    $('.pay-other').click(function(){
       	$('.pay-way').show();
    })
    $('.pay').click(function(){
   	    $('.pay-other').html( $(this).html());
    	$('.pay-way').hide();
   })
    $('.public-btn').click(function(){
       window.location.href="pay_succ.html"
    })
</script>